{%- liquid
  assign file_extension = 'png'
  assign swatch_options = settings.swatch_options | downcase | split: ', '
  assign sort_by = results.sort_by | default: results.default_sort_by
  if results.url
    assign results_url = results.url
  else
    assign terms = results.terms | escape
    assign results_url = '?q=' | append: terms | append: '&options%5Bprefix%5D=last&sort_by=' | append: sort_by
  endif
-%}

<div class="active-filters" data-active-filters>
  {%- for filter in results.filters -%}
    {%- liquid
      assign group_name = filter.label | strip | downcase
    -%}

    {%- for value in filter.active_values -%}
      {%- assign custom_swatch_image = value.label | handle | append: '.' | append: file_extension -%}
      <a
        href="{{ value.url_to_remove }}"
        class="active-filters__active-filter fs-body-75 no-transition"
        data-remove-filter
        data-url-to-remove="{{ value.url_to_remove | split: '?' | last }}"
        data-filter="filter-{{ value.label | handleize | escape }}"
        data-name="{{ value.param_name }}"
        data-value="{{ value.value }}"
        data-name-escaped="{{ value.param_name | url_encode }}"
        data-value-escaped="{{ value.value | url_escape }}"
      >
        {%- if swatch_options contains group_name and show_swatch_filters == true -%}
          {%- liquid
            capture filter_swatch_style
              assign downcased_label = value.label | downcase
              assign swatch_image_url = blank

              # Color
              if value.swatch and value.swatch.color
                echo 'background-color: [[bc]];' | replace: '[[bc]]', value.swatch.color
              else
                if custom_color_key_map contains downcased_label
                  for color_name in custom_color_key_map
                    if color_name == downcased_label
                      echo 'background-color: [[bc]];' | replace: '[[bc]]', custom_color_value_map[forloop.index0]
                      break
                    endif
                  endfor
                else
                  assign color_value = value.label | downcase | replace: ' ', ''

                  echo 'background-color: [[bc]];' | replace: '[[bc]]', color_value
                endif
              endif

              # Image
              #
              # Width of 72 to account for largest swatch display
              if value.swatch and value.swatch.image
                assign swatch_image_url = value.swatch.image | image_url: width: 72
              elsif value.image
                assign swatch_image_url = value.image | image_url: width: 72
              else
                assign custom_swatch_image = value.label | handle | append: '.' | append: file_extension

                if images[custom_swatch_image] != blank
                  assign swatch_image_url = custom_swatch_image | file_img_url: 'small'
                endif
              endif

              if swatch_image_url != blank
                echo ' background-image: url([[siu]]);' | replace: '[[siu]]', swatch_image_url
              endif
            endcapture
          -%}

          <span
            class="active-filters__swatch"
            style="{{ filter_swatch_style }}"
          >
          </span>
        {%- endif -%}

        {%- if filter.type == 'boolean' -%}
          {{ filter.label | escape }}
        {%- else -%}
          {{ value.label | escape }}
        {%- endif -%}
        {%- render 'icon' with icon: 'close-small' -%}
      </a>
    {%- endfor -%}

    {% if filter.type == 'price_range' %}
      {%- if filter.min_value.value != null or filter.max_value.value != null -%}
        <a
          href="{{ value.url_to_remove }}"
          class="active-filters__active-filter fs-body-75 no-transition"
          data-remove-range
          data-url-to-remove="{{ filter.url_to_remove | split: '?' | last }}"
        >
          {%- if filter.min_value.value -%}{{ filter.min_value.value | money }}{%- else -%}{{ 0 | money }}{%- endif -%}
          &nbsp;-&nbsp;
          {%- if filter.max_value.value -%}
            {{ filter.max_value.value | money }}
          {%- else -%}
            {{ filter.range_max | money }}
          {%- endif -%}
          {%- render 'icon' with icon: 'close-small' -%}
        </a>
      {%- endif -%}
    {% endif %}
  {%- endfor -%}

  <a
    href="{{ results_url }}"
    class="active-filters__active-filter active-filters__clear no-transition btn btn--text-link fs-body-75"
    data-clear-all-filters
  >
    <span>{{ 'filters.clear_filters' | t }}</span>
  </a>
</div>
