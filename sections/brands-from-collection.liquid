{%- comment -%}
  Brands grid from a chosen collection — Static multi-column design (no carousel)
  STRICT: logo only from Metaobject; no product fallback, no placeholder.
  Normalized logo box (square) with object-fit: contain so any ratio looks clean.
{%- endcomment -%}

{% schema %}
{
  "name": "Brands from collection",
  "settings": [
    { "type": "collection", "id": "collection", "label": "בחרי קולקציה" },
    { "type": "text", "id": "metaobject_type", "label": "Metaobject type", "default": "brand_info" },
    { "type": "text", "id": "image_field", "label": "Image field (handle)", "default": "Brand_logo" },
    { "type": "text", "id": "name_field",  "label": "Name field (handle)",  "default": "Brand_name" },
    { "type": "number", "id": "columns_desktop", "label": "Columns (desktop)", "default": 5 },
    { "type": "checkbox", "id": "show_debug", "label": "הצג Debug", "default": false }
  ],
  "presets": [{ "name": "Brands grid (static logos)" }]
}
{% endschema %}

{% assign collection_obj = section.settings.collection %}
{% if collection_obj == blank %}
  <p>לא נבחרה קולקציה.</p>
{% else %}
  {% assign meta_type   = section.settings.metaobject_type | default: 'brand_info' %}
  {% assign img_key_in  = section.settings.image_field    | default: 'Brand_logo' %}
  {% assign name_key_in = section.settings.name_field     | default: 'Brand_name' %}
  {% assign cols        = section.settings.columns_desktop | default: 5 %}
  {% assign show_dbg    = section.settings.show_debug %}

  {%- comment -%} ננסה גם וריאציות להנדלים (ליתר בטחון) {%- endcomment -%}
  {% assign img_keys_try  = img_key_in  | append: ',' | append: img_key_in  | handleize | append: ',' | append: img_key_in  | downcase | split: ',' %}
  {% assign name_keys_try = name_key_in | append: ',' | append: name_key_in | handleize | append: ',' | append: name_key_in | downcase | split: ',' %}

  {% assign vendors = collection_obj.products | map: 'vendor' | uniq %}

  <section class="multi-column">
    <div class="page-width">

      <style>
        /* Scoped to this section only */
        #brands-logos-{{ section.id }} .multi-column__grid{
          --columns-desktop: {{ cols }};
          display:grid;
          gap: var(--space-4,24px);
          grid-template-columns: repeat(var(--columns-desktop), 1fr);
        }
        @media (max-width: 1024px){
          #brands-logos-{{ section.id }} .multi-column__grid{
            grid-template-columns: repeat(3, 1fr);
          }
        }
        @media (max-width: 640px){
          #brands-logos-{{ section.id }} .multi-column__grid{
            grid-template-columns: repeat(2, 1fr);
          }
        }

        /* Normalize logo box: perfect square, logo centered, never cropped */
        #brands-logos-{{ section.id }} .multi-column__grid-item-image-figure{
          --image-max-width:100%;
        }
        #brands-logos-{{ section.id }} .multi-column__grid-item-image-wrapper{
          position: relative;
          width: 100%;
          padding-top: 100%; /* square box */
          background: #fff;  /* רקע נקי ללוגואים עם שקיפות */
          border: 1px solid rgba(0,0,0,.06);
          border-radius: 10px;
          overflow: hidden;
        }
        #brands-logos-{{ section.id }} .multi-column__grid-item-image{
          position: absolute; inset: 10% 10% 10% 10%;
          width: 80%; height: 80%;
          object-fit: contain; /* לוגו תמיד בשלמותו */
          object-position: center;
          display:block;
        }
        #brands-logos-{{ section.id }} .multi-column__grid-item-heading{
          text-align:center;
          margin-top: 10px;
        }
      </style>

      <div id="brands-logos-{{ section.id }}" class="brands-logos">
        <div class="multi-column__grid">

          {% for vendor in vendors %}
            {% assign handle = vendor | handleize %}
            {% assign metaobj = shop.metaobjects[meta_type][handle] %}
            {% assign display_name = vendor %}
            {% assign image_obj = nil %}

            {%- comment -%} אם לא נמצא לפי handle — חיפוש לפי שם (lowercase) {%- endcomment -%}
            {% if metaobj == nil %}
              {% assign vendor_down = vendor | downcase %}
              {% for m in shop.metaobjects[meta_type].values %}
                {% assign nm = m[name_key_in] %}
                {% if nm == blank and m.fields[name_key_in] %}
                  {% assign nm = m.fields[name_key_in].value %}
                {% endif %}
                {% if nm != blank %}
                  {% assign nm_down = nm | downcase %}
                  {% if nm_down == vendor_down %}
                    {% assign metaobj = m %}
                    {% break %}
                  {% endif %}
                {% endif %}
              {% endfor %}
            {% endif %}

            {%- comment -%} שם מותג מתוך המטא-אובייקט (אם קיים) {%- endcomment -%}
            {% if metaobj %}
              {% assign candidate_name = metaobj[name_key_in] %}
              {% if candidate_name == blank and metaobj.fields[name_key_in] %}
                {% assign candidate_name = metaobj.fields[name_key_in].value %}
              {% endif %}
              {% if candidate_name == blank %}
                {% for k in name_keys_try %}
                  {% if candidate_name == blank %}
                    {% assign try1 = metaobj[k] %}
                    {% if try1 != blank %}
                      {% assign candidate_name = try1 %}
                    {% elsif metaobj.fields[k] and metaobj.fields[k].value %}
                      {% assign candidate_name = metaobj.fields[k].value %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
              {% endif %}
              {% if candidate_name != blank %}
                {% assign display_name = candidate_name %}
              {% endif %}
            {% endif %}

            {%- comment -%} לוגו מתוך המטא-אובייקט בלבד (אין fallback) {%- endcomment -%}
            {% if metaobj %}
              {% assign candidate_img = metaobj[img_key_in] %}
              {% if candidate_img == blank and metaobj.fields[img_key_in] %}
                {% assign candidate_img = metaobj.fields[img_key_in].value %}
              {% endif %}
              {% if candidate_img == blank %}
                {% for k in img_keys_try %}
                  {% if candidate_img == blank %}
                    {% assign tmp1 = metaobj[k] %}
                    {% if tmp1 != blank %}
                      {% assign candidate_img = tmp1 %}
                    {% elsif metaobj.fields[k] and metaobj.fields[k].value %}
                      {% assign candidate_img = metaobj.fields[k].value %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
              {% endif %}
              {% if candidate_img != blank %}
                {% assign image_obj = candidate_img %}
              {% endif %}
            {% endif %}

            {%- comment -%}
              כרטיס: אם אין לוגו — נציג רק טקסט (ללא שום תמונה/פלייסהולדר/מוצר)
            {%- endcomment -%}
            <div class="multi-column__grid-item">
              <div class="multi-column__grid-item-inner">

                {% if image_obj %}
                  <figure class="multi-column__grid-item-image-figure" data-image-crop-circle="false">
                    <a href="/pages/sample-by-vendor/{{ handle }}" class="multi-column__grid-item-image-wrapper" aria-label="{{ display_name }}">
                      <img class="multi-column__grid-item-image" src="{{ image_obj | image_url: width: 800 }}" alt="{{ display_name }}" loading="lazy">
                    </a>
                  </figure>
                {% endif %}

                <div class="multi-column__grid-item-text-container">
                  <h3 class="multi-column__grid-item-heading ff-heading fs-heading-4-base">
                    <a href="/pages/sample-by-vendor/{{ handle }}" aria-label="{{ display_name }}">{{ display_name }}</a>
                  </h3>

                  {% if show_dbg %}
                    <div class="brand-debug fs-body-75" style="margin-top:6px;color:#666">
                      vendor: {{ vendor }}<br>
                      handle: {{ handle }}<br>
                      metaobj: {% if metaobj %}found{% else %}not found{% endif %}<br>
                      logo: {% if image_obj %}ok{% else %}missing{% endif %}
                    </div>
                  {% endif %}
                </div>

              </div>
            </div>

          {% endfor %}
        </div>
      </div>

    </div>
  </section>
{% endif %}
